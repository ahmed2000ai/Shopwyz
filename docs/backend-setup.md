````markdown
# Shopwyz – Backend Setup (NestJS + Prisma)

This document explains how to create and maintain the NestJS backend for Shopwyz.

It is written for **both humans and AI coding assistants**.  
When generating or modifying backend code, always follow:

- `docs/spec.md`
- `docs/backend-architecture.md`
- `docs/prisma-models-plan.md`
- `prisma/schema.prisma` (the actual DB schema)
- `docs/dev-ai-workflow.md` (how the AI should behave)

---

## 1. Backend Location

The NestJS backend must live in a dedicated folder:

```text
/backend
````

Inside `/backend`, we’ll have a standard NestJS project structure (generated by Nest CLI).

Example:

```text
backend/
  src/
  test/
  package.json
  tsconfig.json
  nest-cli.json
  ...
```

---

## 2. Prerequisites (Local Dev)

When setting up locally (or in Codespaces):

* Node.js: LTS version (e.g. 18+)
* npm or yarn
* PostgreSQL database (local, Docker, or cloud)

For Prisma, the DB connection string will be in the project root `.env`:

```env
DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DB_NAME?schema=public"
```

> NOTE: The `prisma/schema.prisma` file already exists at the repo root level.

---

## 3. Creating the NestJS Project (One Time)

From the **repo root** (where the `docs/` and `prisma/` folders are):

```bash
# Install Nest CLI globally if not installed yet
npm install -g @nestjs/cli

# Create the NestJS project in the backend folder
nest new backend
```

When prompted for the package manager, you can choose `npm` or `yarn`.

This will generate:

```text
backend/
  src/
  test/
  package.json
  ...
```

> IMPORTANT: After generating, make sure the root-level `prisma/` folder stays where it is (do NOT move it inside `backend/`).
> The backend app will simply reference `../prisma/schema.prisma`.

---

## 4. Installing Prisma in the Backend

From inside the `backend` folder:

```bash
cd backend

# Install Prisma and the client
npm install prisma @prisma/client

# (Optional) Initialize Prisma if needed; schema already exists in ../prisma
npx prisma generate --schema=../prisma/schema.prisma
```

Later, to run migrations (when a DB is available):

```bash
npx prisma migrate dev --schema=../prisma/schema.prisma
```

---

## 5. Connecting NestJS to Prisma

In the NestJS app (`backend/src`), we will:

1. Create a `PrismaModule` and `PrismaService`.
2. Use `@prisma/client` to talk to the database using `schema.prisma`.

Example (high-level):

```text
backend/src/
  prisma/
    prisma.module.ts
    prisma.service.ts
```

The Prisma service should import the client generated from:

```ts
import { PrismaClient } from '@prisma/client';
```

and use the `DATABASE_URL` from the environment.

> Any AI coding assistant implementing Prisma integration must:
>
> * Use `../prisma/schema.prisma` as the source schema.
> * NOT overwrite the existing file without aligning with `docs/prisma-models-plan.md`.

---

## 6. Module Structure (Reminder)

The backend should follow the module structure described in:

* `docs/backend-architecture.md`

Key modules to eventually create under `backend/src/`:

* `auth/`
* `users/`
* `households/`
* `lists/`
* `products/`
* `supermarkets/`
* `offers/`
* `preferences/`
* `ai/`
* `realtime/`

Each module should have:

```text
module-name.module.ts
module-name.controller.ts
module-name.service.ts
dto/
entities/ (if needed)
```

---

## 7. Scripts & Commands (Expected)

In `backend/package.json`, we expect standard NestJS scripts such as:

```json
{
  "scripts": {
    "start": "nest start",
    "start:dev": "nest start --watch",
    "build": "nest build",
    "lint": "nest lint",
    "test": "nest test",
    "test:e2e": "nest test:e2e",
    "prisma:generate": "prisma generate --schema=../prisma/schema.prisma",
    "prisma:migrate": "prisma migrate dev --schema=../prisma/schema.prisma"
  }
}
```

> Any AI assistant modifying `package.json` should **preserve or improve** these scripts, not remove them.

---

## 8. AI Coding Assistant Instructions (Backend)

When an AI assistant is asked to work on the backend, it must:

1. **Read the relevant docs**:

   * `docs/spec.md`
   * `docs/backend-architecture.md`
   * `docs/prisma-models-plan.md`
   * `docs/dev-ai-workflow.md`

2. **Work inside `/backend` only** for NestJS code.

3. **Use Prisma models as defined** in `prisma/schema.prisma`.

4. **Not assume** a different project structure than described here.

5. **Ask (or note limitations)** if:

   * The NestJS project has not yet been created in `/backend`.
   * The database connection (`DATABASE_URL`) is not available.

---

## 9. Next Steps (Implementation Order)

Once the `backend` project is created and wired to Prisma, follow the order in `docs/backend-architecture.md`:

1. Basic NestJS + Prisma wiring.
2. Auth + Users.
3. Households.
4. Lists + Realtime.
5. Products + Supermarkets + Offers.
6. Offers recommendation logic.
7. AI parsing module.
8. Preferences and suggestions.
